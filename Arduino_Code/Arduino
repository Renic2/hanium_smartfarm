#include <DHT.h> // DHT22 센서 헤더파일
#include <Wire.h> 
#include <BH1750.h> // BH1750 센서 헤더파일 // I2C 핀이 A4(SDA), A5(SCL)

#define Soil_Moisture_Sensor A0 // SEN030003 센서 아날로그 입력 핀 지정
#define DHTPIN 2 // DHT22 센서 디지털 입력 핀 지정
#define DHTTYPE DHT22

#define Thermal_Pad 7 // 열선 패드 디지털 입력 핀 지정
#define Cooling_Fan 5 // 냉각팬 디지털 입력 핀 지정, MOSFET 사용
#define Water_Pump 6 // 물펌프 디지털 입력 핀 지정, MOSFET 사용
#define LED_Light 9 // LED 디지털 입력 핀 지정
#define LED_Plant_light 10 // 식물생장용 LED 디지털 입력 핀 지정

DHT dht(DHTPIN, DHTTYPE); // DHT22 센서 객체 생성
BH1750 lightMeter; // BH1750 센서 객체 생성

void setup() {
  Serial.begin(9600);
  Wire.begin(); // I2C 시작 (BH1750 센서: I2C 통신을 사용)
  lightMeter.begin(); // BH1750 센서 초기화
}

void loop() {
  
  int Soil_Moisture = analogRead(Soil_Moisture_Sensor); // 토양 수분 측정 (최대: 700, 최소: 0)
  int Soil_Moisture_Percent = map(Soil_Moisture,0,700,0,100); // 토양 수분 함량(%) - 보정 필요
  float h = dht.readHumidity(); // 습도값: 70~90%
  float t = dht.readTemperature(); // 온도값: 적정 온도 15~22
  float lux = lightMeter.readLightLevel(); // 광도값: 0~65535 lx

  analogWrite(LED_Light, 100); // LED 밝기 조절  
  digitalWrite(LED_Plant_light, HIGH); // 식물생장용 LED 켜기

  if (t >= 15 && t <=22){
    Serial.println("적정온도");
    digitalWrite(Thermal_Pad, LOW); // 릴레이 OFF(열선패드 꺼짐)
    digitalWrite(Cooling_Fan, LOW); // 냉각팬 OFF
  }
  else if (t < 15){
    Serial.println("온도가 낮습니다.");
    digitalWrite(Thermal_Pad, HIGH); // 릴레이 ON(열선패드 켜짐)
    digitalWrite(Cooling_Fan, LOW); // 냉각팬 OFF
  }
  else {
    Serial.println("온도가 높습니다.");
    digitalWrite(Cooling_Fan, HIGH); // 냉각팬 ON
    digitalWrite(Thermal_Pad, LOW); // 릴레이 OFF(열선패드 꺼짐)
  } 
 
  // 토양 수분이 30% 미만일 때
  if (Soil_Moisture_Percent < 30) { 
    Serial.println("토양 수분이 부족합니다. 물을 주십시오.");
    analogWrite(Water_Pump, 100); // 물펌프 ON
    delay(5000); // 물펌프 작동 시간: 5초
    digitalWrite(Water_Pump, LOW); // 물펌프 OFF  
  } 
  else {
    Serial.println("토양 수분이 적정합니다.");
    digitalWrite(Water_Pump, LOW); // 물펌프 OFF
  }

  Serial.print("토양 수분: "); 
  Serial.print(Soil_Moisture);
  Serial.println("%");
  Serial.print("습도: ");
  Serial.println(h);
  Serial.print("온도: ");
  Serial.println(t);
  Serial.print("광도: ");
  Serial.print(lux);
  Serial.println(" lx");

  delay(2000); // DHT22센서 측정 시간: 2초
}
